<div class="client-selection-container">
  <div class="search-section">
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Search clients by name or account number</mat-label>
      <input 
        matInput 
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
        placeholder="Enter client name or account number"
      />
      <mat-icon matPrefix>search</mat-icon>
      <button 
        matSuffix 
        mat-icon-button 
        (click)="onSearchChange('')"
        aria-label="Clear search"
        *ngIf="searchTerm()"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <div class="recent-clients-section" *ngIf="recentClients().length > 0">
    <h2>Recent Clients</h2>
    <div class="recent-clients-grid">
      <mat-card class="recent-client-card" *ngFor="let client of recentClients(); trackBy: trackByClientId" (click)="viewRecentClientHoldings(client)">
        <mat-card-content>
          <div class="card-header">
            <h3>{{ client.clientName }}</h3>
            <mat-icon>arrow_forward</mat-icon>
          </div>
          <div class="card-metrics" *ngIf="client.accounts[0]">
            <div class="metric">
              <span class="label">Account:</span>
              <span class="value">{{ client.accounts[0].accountId }}</span>
            </div>
            <div class="metric">
              <span class="label">Market Value:</span>
              <span class="value">{{ formatCurrency(client.accounts[0].marketValue) }}</span>
            </div>
            <div class="metric">
              <span class="label">YTD Performance:</span>
              <span class="value" [class.positive-performance]="client.accounts[0].ytdPerformance >= 0" [class.negative-performance]="client.accounts[0].ytdPerformance < 0">
                {{ formatPercentage(client.accounts[0].ytdPerformance) }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div class="clients-table-section">
    <h2>All Clients</h2>
    
    <div class="loading-container" *ngIf="loading()">
      <mat-spinner></mat-spinner>
    </div>

    <div class="empty-state" *ngIf="!loading() && flattenedAccounts().length === 0">
      <mat-icon>search_off</mat-icon>
      <h3>No clients found</h3>
      <p>Try adjusting your search criteria</p>
    </div>

    <div class="table-container" *ngIf="!loading() && flattenedAccounts().length > 0">
      <table 
        mat-table 
        [dataSource]="flattenedAccounts()" 
        matSort 
        (matSortChange)="onSort($event)"
        class="mat-elevation-z0"
      >
        <ng-container matColumnDef="clientName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Client Name</th>
          <td mat-cell *matCellDef="let account">{{ account.clientName }}</td>
        </ng-container>

        <ng-container matColumnDef="accountId">
          <th mat-header-cell *matHeaderCellDef>Account ID</th>
          <td mat-cell *matCellDef="let account">{{ account.accountId }}</td>
        </ng-container>

        <ng-container matColumnDef="accountType">
          <th mat-header-cell *matHeaderCellDef>Account Type</th>
          <td mat-cell *matCellDef="let account">{{ account.accountType }}</td>
        </ng-container>

        <ng-container matColumnDef="marketValue">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Market Value</th>
          <td mat-cell *matCellDef="let account">{{ formatCurrency(account.marketValue) }}</td>
        </ng-container>

        <ng-container matColumnDef="cashBalance">
          <th mat-header-cell *matHeaderCellDef>Cash Balance</th>
          <td mat-cell *matCellDef="let account">{{ formatCurrency(account.cashBalance) }}</td>
        </ng-container>

        <ng-container matColumnDef="ytdPerformance">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>YTD Performance</th>
          <td mat-cell *matCellDef="let account">
            <span [class.positive-performance]="account.ytdPerformance >= 0" [class.negative-performance]="account.ytdPerformance < 0">
              {{ formatPercentage(account.ytdPerformance) }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="lastActivity">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Activity</th>
          <td mat-cell *matCellDef="let account">{{ formatDate(account.lastActivity) }}</td>
        </ng-container>

        <ng-container matColumnDef="riskProfile">
          <th mat-header-cell *matHeaderCellDef>Risk Profile</th>
          <td mat-cell *matCellDef="let account">{{ account.riskProfile }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let account">
            <button 
              mat-raised-button 
              class="view-holdings-btn"
              (click)="viewHoldings(account.clientId, account.accountId)"
            >
              View Holdings
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </div>
</div>
